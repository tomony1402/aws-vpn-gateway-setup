# aws-vpn-gateway-setup

オンプレミスの分散配信機とAWS環境をVPNで接続し、プライベートIPでの通信を可能にする基盤構築の記録。

## 1. 構成概要
- **オンプレ側**: 分散配信機
- **AWS側**: VPNサーバー (AlmaLinux 9)
- **目的**: 拠点間をプライベートIPで接続し、セキュアな配信環境を構築する。

## 2. ネットワーク設計
セグメントを分離し、ルーティングとDNSによってセキュアな通信を確保。

- **ネットワーク構成**: 
    - AWS VPC（VPNサーバー用セグメント）
    - オンプレミス/他環境（配信機用セグメント）
    ※ 両環境のVPC/ネットワークは分離して運用。
- **VPN接続方式**: StrongSwan (IPsec VPN)
- **名前解決**: 
    - オンプレミス側のDNSにて、配信機のプライベートIPを返すよう構成。
    - これにより、VPNトンネル経由でのセキュアなプライベート通信を実現。
 
## 3. 構築手順

### 3.1 AWS：ネットワーク基盤の準備
VPNサーバーが通信を仲介（ルーティング）できるように設定。

1. **VPCピアリングの設定**
    - VPNサーバー用VPCと配信機用VPCを接続。
    - 各VPCのルートテーブルに、相手側VPCおよびオンプレミス側ネットワーク（CIDR）へのルートを追加。
2. **EC2（AlmaLinux 9）の起動と詳細設定**
    - **ソース/宛先チェックの無効化（重要）**: 
        - [アクション] > [ネットワーキング] > [ソース/宛先チェックを変更] を選択。
        - 「停止」に設定。
        - ※ これを忘れると、自分宛て以外のパケットをEC2が破棄するため、VPN通信が成立しません。
3. **セキュリティグループの解放**
    - StrongSwanが使用するポート（UDP 500, 4500）をオンプレIPに対して許可。


## 4. 疎通確認
- `ping` および `traceroute` を使用し、オンプレ配信機からAWS側のプライベートIPへ到達できることを確認。
- オンプレ側DNSで名前解決を行い、意図したプライベートIPが返ることを確認。
